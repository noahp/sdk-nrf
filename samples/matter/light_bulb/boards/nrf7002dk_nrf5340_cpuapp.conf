#
# Copyright (c) 2021 Nordic Semiconductor ASA
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

# General config
CONFIG_NEWLIB_LIBC=y
CONFIG_FPU=y

# Logging
CONFIG_LOG=y
CONFIG_LOG_MODE_IMMEDIATE=y

# DK
CONFIG_DK_LIBRARY=y

# Memfault
CONFIG_MEMFAULT=y
CONFIG_MEMFAULT_NCS_PROJECT_KEY=""
CONFIG_MEMFAULT_SHELL=y
# CONFIG_MEMFAULT_HTTP_PERIODIC_UPLOAD=y
CONFIG_MEMFAULT_LOGGING_ENABLE=y
CONFIG_MEMFAULT_LOG_LEVEL_DBG=y

# Dependency for Memfault shell
CONFIG_SHELL=y

# Heap and stacks
CONFIG_HEAP_MEM_POOL_SIZE=80000
CONFIG_MAIN_STACK_SIZE=8192
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048
CONFIG_NET_CONNECTION_MANAGER_MONITOR_STACK_SIZE=1024
CONFIG_NET_MGMT_EVENT_STACK_SIZE=1024

# Enable ipv4. If the router supports it, this should enable
# the device to connect to the internet over ipv4.
CONFIG_NET_IPV4=y
CONFIG_BT_RX_STACK_SIZE=1600

####
# Below settings enable OTA.

# Enable OTA
CONFIG_MEMFAULT_HTTP_ENABLE=y
CONFIG_MEMFAULT_HTTP_PERIODIC_UPLOAD=y
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y
CONFIG_STREAM_FLASH=y
CONFIG_FOTA_DOWNLOAD_PROGRESS_EVT=y

# Required for Memfault OTA
CONFIG_NRF_SECURITY=y
CONFIG_PSA_CRYPTO_DRIVER_CC3XX=n
CONFIG_MBEDTLS=y
CONFIG_MBEDTLS_ENABLE_HEAP=y
CONFIG_MBEDTLS_HEAP_SIZE=120000
CONFIG_MBEDTLS_RSA_C=y
CONFIG_MBEDTLS_SSL_SERVER_NAME_INDICATION=y
CONFIG_NET_SOCKETS_SOCKOPT_TLS=y

# Certificate management
CONFIG_MEMFAULT_ROOT_CERT_STORAGE_TLS_CREDENTIAL_STORAGE=y
CONFIG_MEMFAULT_NCS_PROVISION_CERTIFICATES=y

# NCS FOTA Support options
CONFIG_SPI=y
CONFIG_SPI_NOR=y
CONFIG_SPI_NOR_SFDP_DEVICETREE=y
CONFIG_PM_OVERRIDE_EXTERNAL_DRIVER_CHECK=y

CONFIG_BOOTLOADER_MCUBOOT=y
CONFIG_MCUBOOT_IMG_MANAGER=y

CONFIG_IMG_MANAGER=y
CONFIG_STREAM_FLASH=y
CONFIG_IMG_ERASE_PROGRESSIVELY=y

CONFIG_FOTA_DOWNLOAD=y
CONFIG_DFU_TARGET=y

CONFIG_DOWNLOAD_CLIENT=y
CONFIG_DOWNLOAD_CLIENT_STACK_SIZE=4096

CONFIG_MEMFAULT_NRF_CONNECT_SDK=y
CONFIG_MEMFAULT_FOTA=y
CONFIG_DOWNLOAD_CLIENT_MAX_FILENAME_SIZE=400

# Size down some features :/ Matter is very large
CONFIG_CHIP_OTA_REQUESTOR=n
CONFIG_CHIP_NFC_COMMISSIONING=n  # saves ~ 7kB
CONFIG_MATTER_LOG_LEVEL_WRN=y  # saves a lot of space

# Memfault uses HTTPs, so we need to enable TCP
CONFIG_NET_TCP=y
# We also want the device to get an ipv4 address for best compatibility
CONFIG_NET_DHCPV4=y
# # DER-format certificates are smaller than PEM
# CONFIG_MEMFAULT_TLS_CERTS_USE_DER=y

# Increase the network buffer count + fragment size to better support Memfault
# HTTPs requests.
CONFIG_NET_BUF_RX_COUNT=32
CONFIG_NET_BUF_TX_COUNT=32
CONFIG_NET_BUF_DATA_SIZE=256

# Memfault's certs use RSA, so enable this support. Seems to break Matter
# commissioning, unfortunately.
CONFIG_PSA_WANT_KEY_TYPE_RSA_PUBLIC_KEY=y
CONFIG_PSA_WANT_RSA_KEY_SIZE_2048=y

# Below doesn't seem needed after all
# # Specify an ipv6 DNS server, so requests can be sent if the router only supports ipv4 (eg no nat64)
# # CONFIG_DNS_SERVER_IP_ADDRESSES=y
# # CONFIG_DNS_SERVER1="1.1.1.1"

# Enable for debugging
# CONFIG_NET_LOG=y
# CONFIG_NET_CONTEXT_LOG_LEVEL_INF=y

# These are other options for reducing image size, left unset for now
CONFIG_USE_SEGGER_RTT=n
# CONFIG_SHELL=n
CONFIG_OPENTHREAD_SHELL=n
# CONFIG_CONSOLE=y
# CONFIG_UART_CONSOLE=y
# CONFIG_SERIAL=n
# CONFIG_LOG=n
CONFIG_ASSERT_VERBOSE=n
CONFIG_ASSERT_NO_FILE_INFO=y
# CONFIG_PRINTK=n
# CONFIG_PRINTK_SYNC=n
# CONFIG_THREAD_NAME=n
# CONFIG_BOOT_BANNER=n
